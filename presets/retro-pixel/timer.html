<!--
WIDGET_META
Width:420
Height:180
Url:https://github.com/WolfwithSword/SubathonManager/discussions/133#discussioncomment-15301979
showLeadingEmptyTime.Boolean:True
minimumTimeUnitsShown.Int:2
alignment.StringSelect:Center,Left,Right
finishSound.SoundFile:./done.mp3
playSoundOnFinish.Boolean:True
soundVolume.Percent:80
showDays.Boolean:True
END_WIDGET_META
-->
<!--
done.mp3 from: https://freesound.org/people/Scrampunk/sounds/345297/
-->
<link href='https://fonts.googleapis.com/css?family=Press Start 2P' rel='stylesheet'>
<link rel="stylesheet" href="timer.css">
<div class="timer-root" data-state="running" id="timer-row">
    <div class="time-display">
        <div class="time-block" data-unit="days">
            <span id="days">00</span>
            <label>D</label>
        </div>
        <div class="time-block" data-unit="hours">
            <span id="hours">00</span>
            <label>H</label>
        </div>
        <div class="time-block" data-unit="minutes">
            <span id="minutes">00</span>
            <label>M</label>
        </div>
        <div class="time-block" data-unit="seconds">
            <span id="seconds">00</span>
            <label>S</label>
        </div>
    </div>
</div>

<script>
    var hasPlayedFinish = false;
    var completedSound;
    function pad(n, min = 2) {
        return String(n).padStart(min, "0");
    }
    
    function animateValue(el) {
    }
    
    function updateUnitVisibility(data) {
        if (showLeadingEmptyTime) return;
        const order = (typeof showDays !== "undefined" && !showDays)
            ? ["hours", "minutes", "seconds"]
            : ["days", "hours", "minutes", "seconds"];

        const values = {
            days: data.days,
            hours: data.hours,
            minutes: data.minutes,
            seconds: data.seconds
        };

        let firstVisibleIndex = order.findIndex(u => values[u] > 0);

        if (firstVisibleIndex === -1) {
            firstVisibleIndex = order.length - minimumTimeUnitsShown;
        }
        
        firstVisibleIndex = Math.min(
            firstVisibleIndex,
            order.length - minimumTimeUnitsShown
        );

        order.forEach((unit, index) => {
            const block = document.querySelector(
                `.time-block[data-unit="${unit}"]`
            );
            block.style.display = index >= firstVisibleIndex ? "block" : "none";
        });
    }

    function updateTimer(data) {
        let days = data.days;
        let hours = data.hours;
        let minutes = data.minutes;
        let seconds = data.seconds;
        
        if (typeof showDays !== "undefined" && !showDays) {
            hours = (days * 24) + hours;
            days = 0;

            const dayBlock = document.querySelector('.time-block[data-unit="days"]');
            if (dayBlock) dayBlock.style.display = "none";
        }

        if (showDays) {
            if (document.getElementById("days").textContent !== pad(days)) {
                animateValue(document.getElementById("days"));
                document.getElementById("days").textContent = pad(days);
            }
        }
        if (document.getElementById("hours").textContent !== pad(hours, 2)) {
            animateValue(document.getElementById("hours"));
            document.getElementById("hours").textContent = pad(hours, 2);
        }

        if (document.getElementById("minutes").textContent !== pad(minutes)) {
            animateValue(document.getElementById("minutes"));
            document.getElementById("minutes").textContent = pad(minutes);
        }

        if (document.getElementById("seconds").textContent !== pad(seconds)) {
            animateValue(document.getElementById("seconds"));
            document.getElementById("seconds").textContent = pad(seconds);
        }
        updateUnitVisibility({
            days,
            hours,
            minutes,
            seconds
        });
    }
    
    function playFinish(){
        if (typeof(playSoundOnFinish) != "undefined" && playSoundOnFinish) {
            if (typeof(finishSound) != "undefined" && finishSound != "") {
                if (completedSound == undefined)
                    completedSound = new Audio(finishSound);
                completedSound.currentTime = 0;
                completedSound.volume = soundVolume / 100;
                completedSound.play().catch(() => {});
            }
        }
    }

    function handleSubathonUpdate(data) {
        if (data.type !== "subathon_timer") return;
        updateTimer(data);
        if (!hasPlayedFinish && data.total_seconds <= 0){
            hasPlayedFinish = true;
            playFinish();
        }
        else if (data.total_seconds > 0){
            hasPlayedFinish = false;
        }
    }

    if (typeof alignment !== "undefined") {
        document.getElementById("timer-row").classList.add(`${alignment}`.toLowerCase());
    }
</script>