<!--
WIDGET_META
Width:420
Height:180
showLeadingEmptyTime.Boolean:True
minimumTimeUnitsShown.Int:2
alignment.StringSelect:Center,Left,Right
finishSound.SoundFile:./done.mp3
playSoundOnFinish.Boolean:True
soundVolume.Percent:80
END_WIDGET_META
-->
<!--
done.mp3 from: https://freesound.org/people/Scrampunk/sounds/345297/
-->
<link href='https://fonts.googleapis.com/css?family=Press Start 2P' rel='stylesheet'>
<link rel="stylesheet" href="timer.css">
<div class="timer-root" data-state="running" id="timer-row">
    <div class="time-display">
        <div class="time-block" data-unit="days">
            <span id="days">00</span>
            <label>D</label>
        </div>
        <div class="time-block" data-unit="hours">
            <span id="hours">00</span>
            <label>H</label>
        </div>
        <div class="time-block" data-unit="minutes">
            <span id="minutes">00</span>
            <label>M</label>
        </div>
        <div class="time-block" data-unit="seconds">
            <span id="seconds">00</span>
            <label>S</label>
        </div>
    </div>
</div>

<script>
    var hasPlayedFinish = false;
    var completedSound;
    function pad(n) {
        return String(n).padStart(2, "0");
    }
    
    function animateValue(el) {
    }
    
    function updateUnitVisibility(data) {
        if (showLeadingEmptyTime) return;

        const order = ["days", "hours", "minutes", "seconds"];

        const values = {
            days: data.days,
            hours: data.hours,
            minutes: data.minutes,
            seconds: data.seconds
        };

        let firstVisibleIndex = order.findIndex(u => values[u] > 0);

        if (firstVisibleIndex === -1) {
            firstVisibleIndex = order.length - minimumTimeUnitsShown;
        }
        
        firstVisibleIndex = Math.min(
            firstVisibleIndex,
            order.length - minimumTimeUnitsShown
        );

        order.forEach((unit, index) => {
            const block = document.querySelector(
                `.time-block[data-unit="${unit}"]`
            );
            block.style.display = index >= firstVisibleIndex ? "block" : "none";
        });
    }

    function updateTimer(data) {
        if (document.getElementById("days").textContent != pad(data.days)) {
            animateValue(document.getElementById("days"));
            document.getElementById("days").textContent = pad(data.days);
        }
        if (document.getElementById("hours").textContent != pad(data.hours)) {
            animateValue(document.getElementById("hours"));
            document.getElementById("hours").textContent = pad(data.hours);
        }
        if (document.getElementById("minutes").textContent != pad(data.minutes)) {
            animateValue(document.getElementById("minutes"));
            document.getElementById("minutes").textContent = pad(data.minutes);
        }
        if (document.getElementById("seconds").textContent != pad(data.seconds)) {
            animateValue(document.getElementById("seconds"));
            document.getElementById("seconds").textContent = pad(data.seconds);
        }
        updateUnitVisibility(data);
    }
    
    function playFinish(){
        if (typeof(playSoundOnFinish) != "undefined" && playSoundOnFinish) {
            if (typeof(finishSound) != "undefined" && finishSound != "") {
                if (completedSound == undefined)
                    completedSound = new Audio(finishSound);
                completedSound.currentTime = 0;
                completedSound.volume = soundVolume / 100;
                completedSound.play().catch(() => {});
            }
        }
    }

    function handleSubathonUpdate(data) {
        if (data.type !== "subathon_timer") return;
        updateTimer(data);
        if (!hasPlayedFinish && data.total_seconds <= 0){
            hasPlayedFinish = true;
            playFinish();
        }
        else if (data.total_seconds > 0){
            hasPlayedFinish = false;
        }
    }

    if (typeof alignment !== "undefined") {
        document.getElementById("timer-row").classList.add(`${alignment}`.toLowerCase());
    }
</script>