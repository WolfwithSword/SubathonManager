<!--
WIDGET_META
Width:420
Height:110
Url:https://github.com/WolfwithSword/SubathonManager/discussions/133#discussioncomment-15302046
minDisplaySeconds.Float:2
applicableEvents.EventTypeList:TwitchSub,TwitchGiftSub,TwitchGiftSub,TwitchCheer,StreamElementsDonation,StreamLabsDonation,YouTubeMembership,YouTubeGiftMembership,YouTubeSuperChat,TwitchCharityDonation,ExternalDonation,ExternalSub,KoFiSub,KoFiDonation,BlerpBits,BlerpBeets
END_WIDGET_META
-->

<link href="https://fonts.googleapis.com/css?family=Press Start 2P" rel="stylesheet">
<link rel="stylesheet" href="event.css">

<div class="event-root hidden" id="eventRoot">
    <div class="event-content">
        <div class="event-text">
            <div class="event-user" id="eventUser"></div>
            <div class="event-value-currency" id="valueCurrencyWrapper">
                <span class="event-value" id="eventValue"></span>
                <span class="event-currency" id="eventCurrency"></span>
            </div>
        </div>
        <div class="event-icon-wrap" id="eventIcon"></div>
    </div>
</div>

<svg width="0" height="0" style="position:absolute">
    <filter id="pixelate">
        <feFlood x="2" y="2" height="1" width="1"/>
        <feComposite width="4" height="4"/>
        <feTile result="tile"/>
        <feComposite in="SourceGraphic" in2="tile" operator="in"/>
        <feMorphology operator="dilate" radius="1"/>
    </filter>
</svg>

<script>
    const minDisplayMs = (minDisplaySeconds ?? 3) * 1000;

    const root = document.getElementById("eventRoot");
    const userEl = document.getElementById("eventUser");
    const valueEl = document.getElementById("eventValue");
    const currencyEl = document.getElementById("eventCurrency");
    const bottomTextEl = document.getElementById("valueCurrencyWrapper");
    const iconWrap = document.getElementById("eventIcon");

    const queue = [];
    let isPlaying = false;

    function handleSubathonEvent(data) {
        if (data.type != "event") return;
        if (!applicableEvents.includes(data.event_type) && data.event_type != "initial") return;
        queue.push(data);
        processQueue();
    }
    
    async function typeText(el, text, speed = 20) {
        el.textContent = "";
        for (let i = 0; i < text.length; i++) {
            el.textContent += text[i];
            await sleep(speed);
        }
    }

    async function deleteText(el, speed = 10) {
        while (el.textContent.length > 0) {
            el.textContent = el.textContent.slice(0, -1);
            await sleep(speed);
        }
    }
    
    async function processQueue() {
        if (isPlaying || queue.length === 0) return;

        isPlaying = true;
        const event = queue.shift();

        await showEvent(event);
        await sleep(minDisplayMs);

        if (queue.length > 0) {
            await clearEvent();
            isPlaying = false;
            processQueue();
        } else {
            isPlaying = false;
        }
    }

    async function showEvent(e) {
        root.classList.remove("hidden");
        if (e.event_type.includes("Twitch") && e.event_type.includes("Sub")) {
            if (e.value == "1000") e.value = "T1";
            else if (e.value == "2000") e.value = "T2";
            else if (e.value == "3000") e.value = "T3";
            
            if (e.event_type.includes("Gift")) e.value = `x${e.amount} ${e.value}`;
        }
        if (e.event_type.includes("YouTube") && e.event_type.includes("Membership")){
            if (e.event_type.includes("Gift")) e.value = `x${e.amount} ${e.value}`;
        }

        iconWrap.innerHTML = "";
        iconWrap.appendChild(createEventIcon(e.event_type));
        
        await typeText(userEl, e.user, 18)
        await typeText(valueEl, e.value, 14);
        await typeText(currencyEl, e.currency ?? "", 14);
    }
    
    function createEventIcon(eventType) {
        const svgNS = "http://www.w3.org/2000/svg";

        function makeSVG(pathData) {
            const svg = document.createElementNS(svgNS, "svg");
            svg.setAttribute("viewBox", "0 0 24 24");
            svg.classList.add("event-icon");
            svg.setAttribute("transform", "translate(0,-1)");
            svg.setAttribute("preserveAspectRatio", "xMidYMid meet");

            const path = document.createElementNS(svgNS, "path");
            path.setAttribute("d", pathData);
            path.setAttribute("fill", "currentColor");
            svg.appendChild(path);
            return svg;
        }

        switch(eventType) {

            case "YouTubeGiftMembership":
            case "TwitchGiftSub":
                // present
                return makeSVG("M20 12v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-8h16zm0-2H4V8a2 2 0 0 1 2-2h3.17a3 3 0 1 1 0 2H15a3 3 0 1 1 0-2H18a2 2 0 0 1 2 2v2zm-8-5a1 1 0 1 0 0 2h1V7a1 1 0 0 0-1-1z");

            case "YouTubeMembership":
            case "TwitchSub":
            case "ExternalSub":
            case "KoFiSub":
                // star
                return makeSVG("M12 17.3l6.18 3.7-1.64-7.03 5.46-4.73-7.19-.61L12 2 9.19 8.63l-7.19.61 5.46 4.73L5.82 21z");

            case "TwitchCheer":
            case "BlerpBits":
            case "BlerpBeets":
                // diamond
                return makeSVG("M12 2l10 10-10 10L2 12 12 2z");

            case "YouTubeSuperChat":
            case "StreamElementsDonation":
            case "StreamLabsDonation":
            case "TwitchCharityDonation":
            case "ExternalDonation":
            case "KoFiDonation":
                // coin stack
                return makeSVG("M12 2c5 0 9 1.79 9 4s-4 4-9 4-9-1.79-9-4 4-4 9-4zm-9 7v3c0 2.21 4 4 9 4s9-1.79 9-4V9c-2 2-6 3-9 3s-7-1-9-3zm0 6v3c0 2.21 4 4 9 4s9-1.79 9-4v-3c-2 2-6 3-9 3s-7-1-9-3z");

            case "TwitchFollow":
                // person
                return makeSVG("M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5zm0 2c-4.42 0-8 2.24-8 5v3h16v-3c0-2.76-3.58-5-8-5z");

            case "TwitchRaid":
                // group
                return makeSVG("M16 11a4 4 0 1 0-4-4 4 4 0 0 0 4 4zm-8 0a3 3 0 1 0-3-3 3 3 0 0 0 3 3zm0 2c-2.67 0-8 1.34-8 4v3h8zm8-2c-3.33 0-10 1.67-10 5v4h20v-4c0-3.33-6.67-5-10-5z");

            case "Command":
                // < >
                return makeSVG("M8.12 19L2 12l6.12-7 1.41 1.41L5.83 12l3.7 4.59L8.12 19zm7.76 0l-1.41-1.41L18.17 12l-3.7-4.59L15.88 5 22 12l-6.12 7z");

            default:
                // heart
                return makeSVG("M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z");
        }
    }
    
    async function clearEvent() {
        await deleteText(userEl, 8);
        await deleteText(valueEl, 10);
        await deleteText(currencyEl, 10);
    }

    function sleep(ms) {
        return new Promise(r => setTimeout(r, ms));
    }
    
    handleSubathonEvent({
        type: "event",
        event_type: "initial",
        user: "Initializing...",
        value: "Waiting for data"
    })

</script>