<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<link href='https://fonts.googleapis.com/css?family=Quantico' rel='stylesheet'>

<link rel="stylesheet" type="text/css" href="./event.styles.css" />

<div class="events" id="eventsContainer"></div>

<script>
    const eventsContainer = document.getElementById("eventsContainer");
    const eventQueue = [];
    let isProcessing = false;
    let lastEventItem = null;

    // List of event types to display
    const applicableEvents = [
        "init",
        //"TwitchFollow",
        //"TwitchRaid",
        "TwitchSub",
        "TwitchGiftSub",
        "TwitchCheer",
        "StreamElementsDonation",
        "StreamLabsDonation",
        "YouTubeMembership",
        "YouTubeGiftMembership",
        "YouTubeSuperChat"
    ];

    function getEventIcon(type) {
        const ns = "http://www.w3.org/2000/svg";
        const svg = document.createElementNS(ns, "svg");
        svg.setAttribute("viewBox", "0 0 24 24");
        svg.classList.add("event-icon");

        const path = document.createElementNS(ns, "path");
        path.setAttribute("fill", "currentColor");

        switch(type) { 
            case "Command":
                path.setAttribute("d", "M8.12 19L2 12l6.12-7 1.41 1.41L5.83 12l3.7 4.59L8.12 19zm7.76 0l-1.41-1.41L18.17 12l-3.7-4.59L15.88 5 22 12l-6.12 7z"); break;
            case "TwitchRaid":
                path.setAttribute("d", "M16 11a4 4 0 1 0-4-4 4 4 0 0 0 4 4zm-8 0a3 3 0 1 0-3-3 3 3 0 0 0 3 3zm0 2c-2.67 0-8 1.34-8 4v3h8zm8-2c-3.33 0-10 1.67-10 5v4h20v-4c0-3.33-6.67-5-10-5z"); break;
            case "TwitchFollow":
                path.setAttribute("d","M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5zm0 2c-4.42 0-8 2.24-8 5v3h16v-3c0-2.76-3.58-5-8-5z"); break;
            case "YouTubeMembership":
            case "TwitchSub": path.setAttribute("d","M12 17.3l6.18 3.7-1.64-7.03 5.46-4.73-7.19-.61L12 2 9.19 8.63l-7.19.61 5.46 4.73L5.82 21z"); break;
            case "YouTubeGiftMembership":
            case "TwitchGiftSub": path.setAttribute("d","M20 12v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-8h16zm0-2H4V8a2 2 0 0 1 2-2h3.17a3 3 0 1 1 0 2H15a3 3 0 1 1 0-2H18a2 2 0 0 1 2 2v2zm-8-5a1 1 0 1 0 0 2h1V7a1 1 0 0 0-1-1z"); break;
            case "TwitchCheer": path.setAttribute("d","M12 2l10 10-10 10L2 12 12 2z"); break;
            case "YouTubeSuperChat":
            case "StreamElementsDonation":
            case "StreamLabsDonation":
                path.setAttribute("d","M12 2c5 0 9 1.79 9 4s-4 4-9 4-9-1.79-9-4 4-4 9-4zm-9 7v3c0 2.21 4 4 9 4s9-1.79 9-4V9c-2 2-6 3-9 3s-7-1-9-3zm0 6v3c0 2.21 4 4 9 4s9-1.79 9-4v-3c-2 2-6 3-9 3s-7-1-9-3z"); break;
            default: path.setAttribute("d","M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"); break;
        }
        svg.appendChild(path);
        return svg;
    }

    function pushEvent(event) {
        if (!applicableEvents.includes(event.type)) return;
        eventQueue.push(event);
        processQueue();
    }

    function processQueue() {
        if (isProcessing || eventQueue.length === 0) return;
        isProcessing = true;

        const event = eventQueue.shift();

        const item = document.createElement("div");
        item.className = "event-item";

        const icon = getEventIcon(event.type);
        const userSpan = document.createElement("span");
        userSpan.className = "event-user";
        userSpan.textContent = event.user;

        const valueSpan = document.createElement("span");
        valueSpan.className = "event-value";
        if (event.amount) valueSpan.textContent = `x${event.amount} ${event.value || ""}`;
        else if(event.value) valueSpan.textContent = `${event.value} ${event.currency || ""}`;

        item.appendChild(icon);
        item.appendChild(userSpan);
        if(valueSpan.textContent) {
            item.appendChild(document.createTextNode(" | "));
            item.appendChild(valueSpan);
        }

        eventsContainer.appendChild(item);

        item.style.opacity = 0;
        item.style.transform = "translateY(6px)";
        requestAnimationFrame(() => {
            item.style.transition = "all 0.35s ease";
            item.style.opacity = 1;
            item.style.transform = "translateY(0)";
        });

        if (lastEventItem) {
            eventsContainer.removeChild(lastEventItem);
        }

        lastEventItem = item;

        setTimeout(() => {
            isProcessing = false;
            processQueue();
        }, 350);
    }

    function handleSubathonEvent(data) {
        if (!data || data.type !== "event") return;

        if (!applicableEvents.includes(data.event_type)) return;

        let displayValue = "";
        if (data.currency == "sub") {
            if (data.value == "1000") data.value = "T1";
            else if (data.value == "2000") data.value = "T2";
            else if (data.value == "3000") data.value = "T3";
        }
        if (data.currency == "member") {
            data.value = "";
        }
        
        if (data.event_type == "TwitchRaid") {
            data.currency = "viewers";
        }
        
        if (data.event_type === "TwitchGiftSub" || data.event_type === "YouTubeGiftMembership") {
            displayValue = `x${data.amount} ${data.value || ""} ${data.event_type == "YouTubeGiftMembership" ? ' members' : ''}`;
        } else if (data.currency && data.currency !== "sub") {
            displayValue = `${data.value || ""} ${data.currency || ""}`;
        } else if (data.value) {
            displayValue = data.value;
        }

        const event = {
            user: data.user,
            type: data.event_type,
            value: displayValue
        };

        pushEvent(event);
    }

    // initial event
    pushEvent({user:"Welcome!", type:"init", value:""});
</script>