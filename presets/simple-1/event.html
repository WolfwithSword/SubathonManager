<!--
WIDGET_META
Width:300
Height:100
END_WIDGET_META
-->
<meta charset=utf-8>
<link href="https://fonts.cdnfonts.com/css/bright-orchid" rel="stylesheet">
<link href="https://fonts.cdnfonts.com/css/milker" rel="stylesheet">
<link href="https://fonts.cdnfonts.com/css/beachday" rel="stylesheet">
<!--<script src=https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js></script>-->

<link rel="stylesheet" type="text/css" href="./event.styles.css"  />


<div id="event-content" class="event-content"></div>


<script>

const eventTypesToDisplay = ["TwitchGiftSub", 
                             "TwitchSub",
                             "TwitchCheer",
                             "StreamElementsDonation",
                             "StreamLabsDonation",
                             "YouTubeMembership",
                             "YouTubeGiftMembership",
                             "YouTubeSuperChat",
                             //"Command",
                             //"TwitchRaid",
                             //"TwitchFollow",
                             //"Unknown"
                            ];

const eventQueue = [];
let isUpdating = false;
let card = null;

function createEventIcon(eventType) {
  const svgNS = "http://www.w3.org/2000/svg";

  function makeSVG(pathData) {
    const svg = document.createElementNS(svgNS, "svg");
    svg.setAttribute("viewBox", "0 0 24 24");
    svg.classList.add("event-icon");
    svg.setAttribute("transform", "translate(0,-1)");
    svg.setAttribute("preserveAspectRatio", "xMidYMid meet");  

    const path = document.createElementNS(svgNS, "path");
    path.setAttribute("d", pathData);
    path.setAttribute("fill", "currentColor");
    svg.appendChild(path);
    return svg;
  }

  switch(eventType) {
      
    case "YouTubeGiftMembership":
    case "TwitchGiftSub":
      // present
      return makeSVG("M20 12v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-8h16zm0-2H4V8a2 2 0 0 1 2-2h3.17a3 3 0 1 1 0 2H15a3 3 0 1 1 0-2H18a2 2 0 0 1 2 2v2zm-8-5a1 1 0 1 0 0 2h1V7a1 1 0 0 0-1-1z");
      
    case "YouTubeMembership":
    case "TwitchSub":
      // star
      return makeSVG("M12 17.3l6.18 3.7-1.64-7.03 5.46-4.73-7.19-.61L12 2 9.19 8.63l-7.19.61 5.46 4.73L5.82 21z");
      
    case "TwitchCheer":
      // diamond
      return makeSVG("M12 2l10 10-10 10L2 12 12 2z");
  
    case "YouTubeSuperChat":
    case "StreamElementsDonation":
    case "StreamLabsDonation":
      // coin stack
      return makeSVG("M12 2c5 0 9 1.79 9 4s-4 4-9 4-9-1.79-9-4 4-4 9-4zm-9 7v3c0 2.21 4 4 9 4s9-1.79 9-4V9c-2 2-6 3-9 3s-7-1-9-3zm0 6v3c0 2.21 4 4 9 4s9-1.79 9-4v-3c-2 2-6 3-9 3s-7-1-9-3z");

    case "TwitchFollow":
      // person
      return makeSVG("M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5zm0 2c-4.42 0-8 2.24-8 5v3h16v-3c0-2.76-3.58-5-8-5z");

    case "TwitchRaid":
      // group
      return makeSVG("M16 11a4 4 0 1 0-4-4 4 4 0 0 0 4 4zm-8 0a3 3 0 1 0-3-3 3 3 0 0 0 3 3zm0 2c-2.67 0-8 1.34-8 4v3h8zm8-2c-3.33 0-10 1.67-10 5v4h20v-4c0-3.33-6.67-5-10-5z");

    case "Command":
      // < >
      return makeSVG("M8.12 19L2 12l6.12-7 1.41 1.41L5.83 12l3.7 4.59L8.12 19zm7.76 0l-1.41-1.41L18.17 12l-3.7-4.59L15.88 5 22 12l-6.12 7z");

    default:
      // heart
      return makeSVG("M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z");
  }
}


function handleSubathonEvent(data) {
    if (data && data.type == "event") {
        if (!eventTypesToDisplay.includes(data.event_type)) return;
        
        if (data.event_type == "TwitchRaid") {
            data.currency = "viewers";
        }
        if (data.currency == "sub") {
            if (data.value == "1000") data.value = "T1";
            else if (data.value == "2000") data.value = "T2";
            else if (data.value == "3000") data.value = "T3";
        }
        if (data.currency == "member") {
            data.value = "";
        }
        
        let event = {
            "user": data.user,
            "source": data.source,
            "type": data.event_type,
            "currency": data.currency,
            "value": data.value,
            "amount": data.amount
        };
        pushEvent(event);
    }
}

function pushEvent(event) {
  eventQueue.push(event);
  processQueue();
}

function processQueue() {
  if (isUpdating || eventQueue.length === 0) return;

  isUpdating = true;
  const event = eventQueue.shift();
  showEventCard(event);

  setTimeout(() => {
    isUpdating = false;
    processQueue();
  }, 350); // match pop
}

function showEventCard({ user, amount, currency, value, source, type }) {
  if (!card) {
    card = document.createElement("div");
    card.className = "event-card";

    const inner = document.createElement("div");
    inner.className = "event-content";
    card.appendChild(inner);

    document.getElementById("event-content").appendChild(card);
  }
  
  const inner = card.querySelector(".event-content");
  inner.innerHTML = ""; 
  
  const iconEl = createEventIcon(type);
  
  const textWrap = document.createElement("div");
  textWrap.className = "event-text";

  const userDiv = document.createElement("div");
  userDiv.className = "event-user";
  userDiv.textContent = user;

  const valueDiv = document.createElement("div");
  valueDiv.className = "event-value";
  
  if (type == "TwitchGiftSub" || type == "YouTubeGiftMembership") {
      let valContent = `x${amount} ${value}`;
    if (type == "YouTubeGiftMembership") {
        valContent = `x${amount} ${value} members`;
    }
      valueDiv.textContent = valContent;
  }
  else if (currency != 'sub' && currency != "") {
    valueDiv.textContent = `${value} ${currency}`;
  }
  else if (value != "") {
    valueDiv.textContent = value;
  }


  textWrap.appendChild(userDiv);
  textWrap.appendChild(valueDiv);

  inner.appendChild(textWrap);
  inner.appendChild(iconEl);

  requestAnimationFrame(() => {
      inner.classList.remove("animating");
      void inner.offsetWidth;
      inner.classList.add("animating");
  });
}


pushEvent({"user": "Welcome!", "currency": "", "value": ""});
</script>