<ui:FluentWindow x:Class="SubathonManager.UI.EditRouteWindow"
                 xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                 xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                 xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
                 xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
                 xmlns:local="clr-namespace:SubathonManager.UI"
                 xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
                 mc:Ignorable="d"
                 Background="{DynamicResource AppGeneralBackground}"
                 ResizeMode="NoResize"
                 WindowStartupLocation="CenterOwner" MinHeight="500" MinWidth="940"
                 Title="Overlay Editor" Height="900" Width="1740">
    <ui:FluentWindow.Resources>
        <Style x:Key="OpaqueSecondaryButton" TargetType="ui:Button" BasedOn="{StaticResource {x:Type ui:Button}}">
            <Setter Property="Appearance" Value="Secondary"/>
            <Setter Property="Background" Value="{DynamicResource OpaqueSecondaryBackground}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource OpaqueSecondaryBackgroundBorder}"/>
            <Setter Property="Opacity" Value="1"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ui:Button">
                        <Border x:Name="ButtonBorder" Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="4">
                            <ContentPresenter HorizontalAlignment="Center"
                                              VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="ButtonBorder" Property="Background" Value="{DynamicResource OpaqueSecondaryBackgroundHover}"/>
                                <Setter TargetName="ButtonBorder" Property="BorderBrush" Value="{DynamicResource OpaqueSecondaryBackgroundHover}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="ButtonBorder" Property="Background" Value="{DynamicResource OpaqueSecondaryBackgroundPressed}"/>
                                <Setter TargetName="ButtonBorder" Property="BorderBrush" Value="{DynamicResource OpaqueSecondaryBackgroundPressed}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </ui:FluentWindow.Resources>
    <Grid
        Background="{DynamicResource AppGeneralBackground}">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="370"/>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="370"/>
        </Grid.ColumnDefinitions>
        
        
        <ui:TitleBar Title="Overlay Editor" Grid.ColumnSpan="3"
                     ShowMinimize="True"
                     Background="{DynamicResource AppTitleBackground}"
                     Foreground="{DynamicResource TextFillColorPrimaryBrush}"
                     VerticalContentAlignment="Top"
                     ShowMaximize="True"
                     ShowClose="True"
                     FontSize="14"
                     Padding="12 8 12 8"
                     DockPanel.Dock="Top">
            <ui:TitleBar.Icon>
                <ui:ImageIcon VerticalAlignment="Top"
                              RenderOptions.BitmapScalingMode="HighQuality"
                              SnapsToDevicePixels="True"
                              UseLayoutRounding="True">
                    <ui:ImageIcon.Source>
                        <BitmapImage UriSource="pack://application:,,,/icon.png" />
                    </ui:ImageIcon.Source>
                </ui:ImageIcon>
            </ui:TitleBar.Icon>
        </ui:TitleBar>
        
        <!-- LEFT - widget list and route settings -->
        <Grid Grid.Column="0" Margin="12 44 12 12" >
            
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>
            
            <StackPanel Orientation="Vertical" Background="{DynamicResource UiBrushControlBackground}">
                <TextBlock Text="Overlay" FontWeight="SemiBold" Margin="0,12,0,8"/>
                <TextBlock Text="Name" FontSize="12" />
                <TextBox x:Name="RouteNameBox" Margin="0,4,0,8"/>
                <StackPanel Orientation="Horizontal">
                    <StackPanel Margin="0 2 2 2">
                        <TextBlock Text="Width" FontSize="12"/>
                        <TextBox x:Name="RouteWidthBox" Width="120" PreviewTextInput="NumberOnly_PreviewTextInput"/>
                    </StackPanel>
                    <StackPanel Margin="2 2 0 2">
                        <TextBlock Text="Height" FontSize="12"/>
                        <TextBox x:Name="RouteHeightBox" Width="120" PreviewTextInput="NumberOnly_PreviewTextInput"/>
                    </StackPanel>
                </StackPanel>

                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,10,0,0">
                    <ui:Button Padding="2"
                               ToolTip="Copy URL to clipboard"
                               Width="32" Height="32"
                               Margin="4,0,4,0"
                               Click="CopyOverlayUrl_Click"><ui:SymbolIcon Symbol="Link24" />
                    </ui:Button>

                    <ui:Button Padding="2" ToolTip="Open in browser"
                               Width="32" Height="32"
                               Margin="4,0,194,0"
                               Click="OpenOverlayInBrowser_Click"><ui:SymbolIcon Symbol="Open24"/>
                    </ui:Button>
                    <ui:Button x:Name="SaveRouteButton" Content="Save" Width="80" Click="SaveRouteButton_Click"/>
                </StackPanel>
            </StackPanel>

            <StackPanel Grid.Row="1">
                <Separator Margin="0,12"/>

                <!-- Widgets -->
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="0,0,0,8">
                    <TextBlock Text="Widgets" FontWeight="Bold" FontSize="16" VerticalAlignment="Center"/>
                    <ui:Button x:Name="ImportWidgetButton" Padding="2" Icon="Add20" Content="Import Widget" Margin="8,0,0,0" Click="ImportWidgetButton_Click"/>
                </StackPanel>
            </StackPanel>

            <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto">
                <ItemsControl x:Name="WidgetsList" >
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <ui:Card x:Name="WidgetCard"  MouseDoubleClick="WidgetCard_MouseDoubleClick" Margin="0,0,0,8" Padding="10" Background="{DynamicResource UiBrushControlBackground}">
                                <ui:Card.Triggers>
                                    <EventTrigger RoutedEvent="MouseEnter">
                                        <BeginStoryboard>
                                            <Storyboard>
                                                <DoubleAnimation Storyboard.TargetName="WidgetActions"
                                                                 Storyboard.TargetProperty="Opacity"
                                                                 To="1" Duration="0:0:0.15"/>
                                            </Storyboard>
                                        </BeginStoryboard>
                                    </EventTrigger>
                                    <EventTrigger RoutedEvent="MouseLeave">
                                        <BeginStoryboard>
                                            <Storyboard>
                                                <DoubleAnimation Storyboard.TargetName="WidgetActions"
                                                                 Storyboard.TargetProperty="Opacity"
                                                                 To="0" Duration="0:0:0.15"/>
                                            </Storyboard>
                                        </BeginStoryboard>
                                    </EventTrigger>
                                </ui:Card.Triggers>
                                <Grid>
                                    <StackPanel VerticalAlignment="Center" HorizontalAlignment="Stretch">
                                        <TextBlock Text="{Binding Name}" FontSize="14" FontWeight="SemiBold" TextWrapping="Wrap"/>
                                        <TextBlock Text="{Binding Z, StringFormat=Z: {0}}" FontSize="11" Foreground="{DynamicResource UiBrushTextTertiary}"/>
                                    </StackPanel>

                                    <StackPanel x:Name="WidgetActions" Orientation="Horizontal" VerticalAlignment="Top" 
                                                Panel.ZIndex="1" Opacity="0" HorizontalAlignment="Right">
                                        <ui:Button Padding="2" Margin="2 0 2 0" ToolTip="Toggle Visibility" Click="ToggleVisibility_Click" 
                                                   Width="30" Height="30" Style="{StaticResource OpaqueSecondaryButton}" >
                                            <ui:SymbolIcon>
                                                <ui:SymbolIcon.Style>
                                                    <Style TargetType="ui:SymbolIcon">
                                                        <Setter Property="Symbol" Value="Eye20"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding Visibility}" Value="False">
                                                                <Setter Property="Symbol" Value="EyeOff20"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </ui:SymbolIcon.Style>
                                            </ui:SymbolIcon>
                                        </ui:Button>
                                        <ui:Button Padding="2" Margin="2 0 2 0" ToolTip="Move Up" Click="MoveUp_Click" Width="30" Height="30" Appearance="Primary">
                                            <ui:SymbolIcon Symbol="ChevronUp20"/>
                                        </ui:Button>
                                        <ui:Button Padding="2" Margin="2 0 2 0" ToolTip="Move Down" Click="MoveDown_Click" Width="30" Height="30" Appearance="Primary">
                                            <ui:SymbolIcon Symbol="ChevronDown20"/>
                                        </ui:Button>
                                        <ui:Button Padding="2" Margin="2 0 2 0" ToolTip="Edit" Click="EditWidget_Click" Width="30" Height="30" 
                                                   Style="{StaticResource OpaqueSecondaryButton}">
                                            <ui:SymbolIcon Symbol="Edit20"/>
                                        </ui:Button>
                                        <ui:Button Padding="2" Margin="2 0 2 0" ToolTip="Copy" Click="CopyWidget_Click" 
                                                   Style="{StaticResource OpaqueSecondaryButton}" 
                                                   Width="30" Height="30">
                                            <ui:SymbolIcon Symbol="Copy20"/>
                                        </ui:Button>
                                        <ui:Button Padding="2" Margin="2 0 2 0" ToolTip="Delete" Click="DeleteWidget_Click" Width="30" Height="30" Appearance="Danger">
                                            <ui:SymbolIcon Symbol="Delete20"/>
                                        </ui:Button>
                                    </StackPanel>
                                </Grid>
                            </ui:Card>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>
        </Grid>
        
        <!-- MIDDLE - webview editor -->
        <Grid Grid.Column="1" Margin="12 40 12 12"> 
            <Border Background="{DynamicResource UiBrushSurface}" CornerRadius="8" Padding="6">
                
                <Grid x:Name="WebViewContainer" Background="Black">
                <wv2:WebView2 x:Name="PreviewWebView" 
                              xmlns:wv2="clr-namespace:Microsoft.Web.WebView2.Wpf;assembly=Microsoft.Web.WebView2.Wpf"
                              HorizontalAlignment="Stretch"
                              VerticalAlignment="Stretch" 
                              Width="{Binding _route.Width}" 
                              Height="{Binding _route.Height}"
                              DefaultBackgroundColor="White"/>
                </Grid>
            </Border>
        </Grid>
        
        <!-- RIGHT - widget editor -->
        <Border Grid.Column="2" Background="{DynamicResource UiBrushPrimary}" Padding="0 12 12 12">
            <Grid x:Name="WidgetEditorPanel">

                <StackPanel x:Name="EmptyEditorPanel">
                    <TextBlock Text="Widget Editor" FontWeight="SemiBold" Margin="0,44,0,8"/>
                    <TextBlock Text="Please select a widget to edit in the left column.&#10;When editing, hold shift to resize while preserving aspect ratio." 
                               Foreground="Gray" FontSize="13" TextWrapping="Wrap" />
                </StackPanel>

                <Grid x:Name="WidgetEditPanel" Visibility="Collapsed">
                    <DockPanel LastChildFill="True">
                        <StackPanel DockPanel.Dock="Top">
                            <TextBlock Text="Widget Editor" FontSize="18" FontWeight="Bold" Margin="0,-8,0,24"/>
                            <StackPanel Margin="0,8">
                                <TextBlock Text="Name" FontWeight="SemiBold" Margin="2 2"/>
                                <TextBox x:Name="WidgetNameBox"/>
                            </StackPanel>

                            <UniformGrid Columns="2" Rows="2" Margin="0,8">
                                <StackPanel>
                                    <TextBlock Text="Width" FontWeight="SemiBold" Margin="2 2"/>
                                    <TextBox x:Name="WidgetWidthBox"  Margin="4 1" PreviewTextInput="NumberOnly_PreviewTextInput"/>
                                </StackPanel>
                                <StackPanel>
                                    <TextBlock Text="Height" FontWeight="SemiBold" Margin="2 2"/>
                                    <TextBox x:Name="WidgetHeightBox"  Margin="4 1" PreviewTextInput="NumberOnly_PreviewTextInput"/>
                                </StackPanel>
                                <StackPanel>
                                    <TextBlock Text="X" FontWeight="SemiBold" Margin="2 2"/>
                                    <TextBox x:Name="WidgetXBox" Margin="4 1" PreviewTextInput="NumberOrNegativeOnly_PreviewTextInput"/>
                                </StackPanel>
                                <StackPanel>
                                    <TextBlock Text="Y" FontWeight="SemiBold" Margin="2 2"/>
                                    <TextBox x:Name="WidgetYBox"  Margin="4 1" PreviewTextInput="NumberOrNegativeOnly_PreviewTextInput"/>
                                </StackPanel>
                                <StackPanel>
                                    <TextBlock Text="ScaleX" FontWeight="SemiBold" Margin="2 2"/>
                                    <TextBox x:Name="WidgetScaleXBox" Margin="4 1" PreviewTextInput="NumberOrDecimalOnly_PreviewTextInput"/>
                                </StackPanel>
                                <StackPanel>
                                    <TextBlock Text="ScaleY" FontWeight="SemiBold" Margin="2 2"/>
                                    <TextBox x:Name="WidgetScaleYBox"  Margin="4 1" PreviewTextInput="NumberOrDecimalOnly_PreviewTextInput"/>
                                </StackPanel>
                            </UniformGrid>

                            <Separator Margin="0 32 0 8"/>
                        </StackPanel>
                        
                        <StackPanel  DockPanel.Dock="Bottom" VerticalAlignment="Bottom" Orientation="Horizontal" HorizontalAlignment="Center" Margin="0 4">
                            <Button Content="Reload Vars" Width="150" Margin="4,8,4,4" Click="ReloadVars_Click" HorizontalAlignment="Left"/>
                            <Button x:Name="SaveWidgetButton" Content="Save" Width="150" Margin="4,8,4,4"
                                    Click="SaveWidgetButton_Click" HorizontalAlignment="Right"/>
                        </StackPanel>
                        
                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                            <StackPanel>
                                <!-- CSS Variables -->
                                <Expander Header="CSS Variables" IsExpanded="False" Margin="0 0 4 0">
                                        <ItemsControl x:Name="CssVarsList">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <StackPanel Orientation="Vertical"> 
                                                        <StackPanel Orientation="Horizontal" Margin="0,2">
                                                            <TextBlock VerticalAlignment="Center" Text="{Binding Name}" ToolTip="{Binding Name}" Width="180"/>
                                                            <TextBox Text="{Binding Value}" Width="150"/>
                                                        </StackPanel>
                                                        <Separator Margin="16 1"></Separator>
                                                    </StackPanel>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                </Expander>

                                <!-- JS Variables -->
                                <Expander Header="JS Variables" IsExpanded="False" Margin="0 0 4 6">
                                    <ItemsControl x:Name="JsVarsList">

                                    </ItemsControl>
                                </Expander>
                            </StackPanel>
                        </ScrollViewer>
                    </DockPanel>
                </Grid>
            </Grid>
        </Border>

    </Grid>
</ui:FluentWindow>
