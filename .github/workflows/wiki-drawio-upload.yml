name: Update Wiki Drawio

on:
  workflow_dispatch:
  workflow_call:
    inputs:
      release_tag:
        type: string
        required: false

jobs:
  update:
    name: Update Wiki Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Check if wiki repository exists
        id: wiki-check
        run: |
          set -e
          WIKI_URL="https://github.com/${{ github.repository }}.wiki.git"
          if git ls-remote "$WIKI_URL" &>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Stop if no wiki exists
        if: steps.wiki-check.outputs.exists == 'false'
        run: echo "Wiki does not exist — skipping update."
          
      - name: Checkout Wiki Repository
        if: steps.wiki-check.outputs.exists == 'true'
        uses: actions/checkout@v5
        with:
          repository: ${{ github.repository }}.wiki
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Download draw.io file from Nextcloud
        if: steps.wiki-check.outputs.exists == 'true'
        run: |
          mkdir -p docs
          curl -L "${{ vars.NEXTCLOUD_DRAWIO_URL }}" \
            -o "docs/SubathonManager_Design.drawio"
          
      - name: Render drawio to png
        uses: rlespinasse/drawio-export-action@v2
        with:
          path: "docs/SubathonManager_Design.drawio"
          format: png
          output: docs
          all-pages: true

      - name: Commit drawio file
        if: steps.wiki-check.outputs.exists == 'true'
        run: |
          
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          
          mv "docs/SubathonManager_Design.drawio" "docs/SubathonManager Design.drawio"
          
          git add "docs/SubathonManager Design.drawio"
          git add "docs/*.png"

          if git diff --cached --quiet; then
            echo "No changes detected, skipping commit."
          else
            git commit -m "Update Subathon Manager.drawio for release ${{ inputs.release_tag || 'manual run' }}"
            git push
          fi
