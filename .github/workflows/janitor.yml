name: janitor

on:
  schedule:
    - cron: "45 5 * * *"
  workflow_dispatch:

permissions:
  actions: write
  contents: read

jobs:
  prune-actions-storage:
    runs-on: ubuntu-latest
    steps:
      - name: Delete caches older than 7 days
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cutoff="$(date -u -d '7 days ago' +%s)"
          
          gh cache list --repo ${{ github.repository }} --json id,key,createdAt | \
          jq -c '.[]' | while read -r item; do
            id=$(jq -r '.id' <<< "$item")
            key=$(jq -r '.key' <<< "$item")
            created=$(jq -r '.createdAt' <<< "$item")
            ts=$(date -u -d "$created" +%s)
            
            if [ "$ts" -lt "$cutoff" ]; then
              echo "Deleting cache ID $id (key: $key, created $created)"
              gh cache delete "$id" --repo ${{ github.repository }} || true
            fi
          done
